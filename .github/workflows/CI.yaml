---
name: CI
on:
  pull_request:
    paths:
      - "pkg-precompile.jl"
      - "test/**"
      - ".github/workflows/CI.yaml"
  push:
    branches:
      - main
    tags: ["*"]

jobs:
  version:
    name: Resolve Julia Versions
    # These permissions are needed to:
    # - Checkout the Git repository (`contents: read`)
    permissions:
      contents: read
    runs-on: ubuntu-latest
    outputs:
      json: ${{ steps.julia-version.outputs.resolved-json }}
    steps:
      - uses: actions/checkout@v4 # Needed for "min" to access the Project.toml
      - uses: julia-actions/julia-version@v0.1.0
        id: julia-version
        with:
          versions: |
            - min  # Oldest supported version
            - lts  # Long-Term Stable
            - 1    # Latest release
          project: test

  test:
    name: Julia ${{ matrix.version }} - ${{ matrix.os }}
    needs: version
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        version: ${{ fromJSON(needs.version.outputs.json) }}
        os:
          - ubuntu-24.04
          - ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v4
      - uses: julia-actions/setup-julia@v2
        with:
          version: ${{ matrix.version }}
          arch: ${{ matrix.arch }}
      - uses: julia-actions/cache@v1
      - uses: julia-actions/julia-runtest@v1
      - uses: julia-actions/julia-processcoverage@v1
      - uses: codecov/codecov-action@v5
        with:
          files: lcov.info
